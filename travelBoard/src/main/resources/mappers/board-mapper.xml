<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="edu.kh.travel.board.model.mapper.BoardMapper">
	<!-- 게시판 종류 목록 조회 (+ 표기법 변경) (이건 헤더에 대륙별 이름 보이는 데 사용할 용도) -->
	<select id="selectBoardTypeList">
		SELECT CONTI_CODE "contiCode", 
		CONTI_NAME "contiName" 
		FROM "CONTINENT"
		ORDER BY CONTI_NAME
	</select>
	<!-- ===================================================================== -->
	<!-- 게시글 목록 조회 서비스(boardList)에서 사용되는 여러 매퍼들  -->
	
	<!-- 삭제되지 않은 게시글 수 조회 -->
	<select id="getListCount">
		SELECT COUNT(*)
	FROM "BOARD"
	JOIN "COUNTRY" USING (COUNTRY_CODE)
	JOIN "CONTINENT" USING (CONTI_CODE)
	WHERE BOARD_DEL_FL='N'
	AND CONTI_CODE=#{selectContinent}
	
	</select>
	
		<!-- 해당 대륙 게시판으로 이동 -->
	<select id="selectBoardList">
	
SELECT BOARD_NO, BOARD_TITLE, MEMBER_NICKNAME, READ_COUNT,
	(SELECT COUNT(*) FROM "COMMENT" C
	WHERE C.BOARD_NO = B.BOARD_NO) COMMENT_COUNT,
	(SELECT COUNT(*)
	FROM "LIKE" L
	WHERE L.BOARD_NO = B.BOARD_NO) LIKE_COUNT,
	<![CDATA[ 
		CASE 
			WHEN SYSDATE-WRITE_DATE < 1/24/60
			THEN FLOOR((SYSDATE-WRITE_DATE)*24*60*60)||'초 전'
			
			WHEN SYSDATE-WRITE_DATE <1/24
			THEN FLOOR((SYSDATE-WRITE_DATE)*24*60)||'분 전'
			
			WHEN SYSDATE-WRITE_DATE <1
			THEN FLOOR((SYSDATE-WRITE_DATE)*24)||'시간 전'
			
			ELSE TO_CHAR(WRITE_DATE, 'YYYY-MM-DD')
		END WRITE_DATE 
		]]>
	FROM "BOARD" B
	JOIN "MEMBER" M USING (MEMBER_NO)
	JOIN "COUNTRY" USING (COUNTRY_CODE)
	JOIN "CONTINENT" USING (CONTI_CODE)
	WHERE BOARD_DEL_FL = 'N'
	AND CONTI_CODE = #{contiCode}
	ORDER BY BOARD_NO DESC
	</select>
	
	<!-- 검색 조건에 맞는 게시글 수 조회하기(카운트한 결과값이 반환된다) -->
	<select id="getSearchCount">
	SELECT COUNT(*)
		FROM "BOARD"
		JOIN "COUNTRY" USING (COUNTRY_CODE)
		JOIN "CONTINENT" USING (CONTI_CODE)
		<!-- 작성자 검색인 경우 if문 -->
		<if test='key =="w"'>
		JOIN "MEMBER" USING (MEMBER_NO)
		</if>
		
		WHERE BOARD_DEL_FL='N'
		AND CONTI_CODE=#{contiCode}
		<choose>
		
		<!-- 제목으로만 검색(key 값이 "t"인 경우일 때) 
		$를 사용하는 것 지양-->
		<when test='key == "t"'>
		AND BOARD_TITLE LIKE '%' || #{query} || '%'
		</when>
		
		<!-- 내용으로만 검색(key 값이 "c"인 경우일 때) 
		$를 사용하는 것 지양-->
		<when test='key == "c"'>
		AND BOARD_CONTENT LIKE '%' || #{query} || '%'
		</when>
		
		<!-- 제목+내용으로 검색(key 값이 "tc"인 경우일 때) 
		$를 사용하는 것 지양-->
		<when test='key == "tc"'>
		AND (BOARD_TITLE LIKE '%' || #{query} || '%'
					OR 
			BOARD_CONTENT LIKE '%' || #{query} || '%')
		</when>
		
		<!-- 작성자 검색 (key값이 "w"인 경우) -->
		<otherwise>
		 AND MEMBER_NICKNAME LIKE '%' || #{query} || '%'
		</otherwise>
		</choose>
	</select>
		
		<!-- 지정된 페이지의 검색 결과 게시글 목록 조회 -->
		<select id="selectSearchList">
			
SELECT BOARD_NO, BOARD_TITLE, MEMBER_NICKNAME, READ_COUNT,
	(SELECT COUNT(*) FROM "COMMENT" C
	WHERE C.BOARD_NO = B.BOARD_NO) COMMENT_COUNT,
	(SELECT COUNT(*)
	FROM "LIKE" L
	WHERE L.BOARD_NO = B.BOARD_NO) LIKE_COUNT,
	<![CDATA[ 
		CASE 
			WHEN SYSDATE-WRITE_DATE < 1/24/60
			THEN FLOOR((SYSDATE-WRITE_DATE)*24*60*60)||'초 전'
			
			WHEN SYSDATE-WRITE_DATE <1/24
			THEN FLOOR((SYSDATE-WRITE_DATE)*24*60)||'분 전'
			
			WHEN SYSDATE-WRITE_DATE <1
			THEN FLOOR((SYSDATE-WRITE_DATE)*24)||'시간 전'
			
			ELSE TO_CHAR(WRITE_DATE, 'YYYY-MM-DD')
		END WRITE_DATE 
		]]>
	FROM "BOARD" B
	JOIN "MEMBER" M USING (MEMBER_NO)
	JOIN "COUNTRY" R USING (COUNTRY_CODE)
	JOIN "CONTINENT" T USING (CONTI_CODE)
	WHERE BOARD_DEL_FL = 'N'
	AND CONTI_CODE = #{contiCode}
	<choose>
		
		<!-- 제목으로만 검색(key 값이 "t"인 경우일 때) 
		$를 사용하는 것 지양-->
		<when test='key == "t"'>
		AND BOARD_TITLE LIKE '%' || #{query} || '%'
		</when>
		
		<!-- 내용으로만 검색(key 값이 "c"인 경우일 때) 
		$를 사용하는 것 지양-->
		<when test='key == "c"'>
		AND BOARD_CONTENT LIKE '%' || #{query} || '%'
		</when>
		
		<!-- 제목+내용으로 검색(key 값이 "tc"인 경우일 때) 
		$를 사용하는 것 지양-->
		<when test='key == "tc"'>
		AND (BOARD_TITLE LIKE '%' || #{query} || '%'
					OR 
			BOARD_CONTENT LIKE '%' || #{query} || '%')
		</when>
		
		<!-- 작성자 검색 (key값이 "w"인 경우) -->
		<otherwise>
		 AND MEMBER_NICKNAME LIKE '%' || #{query} || '%'
		</otherwise>
		</choose>
	ORDER BY BOARD_NO DESC
	
		</select>
	<!-- ===================================================================== -->
</mapper>
